# –õ–∏–º–∏—Ç—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ–∑—é–º–µ

## üéâ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ë–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
‚úÖ **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤
‚úÖ **–õ–∏–º–∏—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ Marzneshin** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
‚úÖ **API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** - —Å–æ–∑–¥–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** - –Ω–æ–≤—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞

### 2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ–∫—Å–∏ (–ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ)
‚úÖ **–†–∞—Å—à–∏—Ä–µ–Ω –ø—Ä–æ—Ç–æ–∫–æ–ª** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è device_limit, allowed_fingerprints –≤ proto
‚úÖ **–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö** - Marzneshin –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–∞ —É–∑–ª—ã
‚úÖ **–ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —É–∑–ª—ã
‚úÖ **–ù–∞—Å—Ç—Ä–æ–π–∫–∞** - –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ ENFORCE_DEVICE_LIMITS_ON_PROXY

## üìã –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –®–∞–≥ 1: –†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å protobuf —Ñ–∞–π–ª—ã
```bash
cd app/marznode
python -m grpc_tools.protoc -I. \
    --python_out=. \
    --grpc_python_out=. \
    --pyi_out=. \
    marznode.proto
```

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
```bash
# Docker
docker-compose exec marzneshin alembic upgrade head

# –õ–æ–∫–∞–ª—å–Ω–æ
alembic upgrade head
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
```bash
docker-compose restart marzneshin
```

### –®–∞–≥ 4 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ .env
```bash
# –í–∫–ª—é—á–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ–∫—Å–∏ (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ marznode)
ENFORCE_DEVICE_LIMITS_ON_PROXY=true
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API

### –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤
```bash
curl -X PUT "http://localhost:8000/api/users/username" \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"device_limit": 3}'
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```bash
curl -X GET "http://localhost:8000/api/admin/users/username/devices" \
  -H "Authorization: Bearer TOKEN"
```

### –£–¥–∞–ª–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
```bash
curl -X DELETE "http://localhost:8000/api/admin/users/username/devices/5" \
  -H "Authorization: Bearer TOKEN"
```

### –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
```bash
curl -X PATCH "http://localhost:8000/api/admin/users/username/devices/5" \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"is_blocked": true}'
```

## üîß –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å

### ‚úÖ –£—Ä–æ–≤–µ–Ω—å Marzneshin (—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é)
1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ fingerprint
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞** - –Ω–æ–≤—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
3. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API** - —É–¥–∞–ª–µ–Ω–∏–µ, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –ø—Ä–æ—Å–º–æ—Ç—Ä
4. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - —Ç—Ä–∞—Ñ–∏–∫, IP –∞–¥—Ä–µ—Å–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

### ‚è≥ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–∫—Å–∏ (—Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ marznode)
- **Marzneshin –≥–æ—Ç–æ–≤** - –ø–µ—Ä–µ–¥–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- **Marznode —Ç—Ä–µ–±—É–µ—Ç** - –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É fingerprint –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏

## üìä –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –õ–∏–º–∏—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (device_limit = null)
```
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 1 ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è ‚úÖ
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 2 ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è ‚úÖ
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 3 ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è ‚úÖ
... –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –õ–∏–º–∏—Ç = 2 (–±–µ–∑ marznode –¥–æ—Ä–∞–±–æ—Ç–∫–∏)
```
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 1 ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è ‚úÖ ‚Üí Marznode: —Ä–∞–∑—Ä–µ—à–µ–Ω–æ ‚úÖ
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 2 ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è ‚úÖ ‚Üí Marznode: —Ä–∞–∑—Ä–µ—à–µ–Ω–æ ‚úÖ
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 3 ‚Üí –ù–ï —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è ‚ùå ‚Üí Marznode: —Ä–∞–∑—Ä–µ—à–µ–Ω–æ* ‚ö†Ô∏è

* –ü—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ –≤–µ–¥–µ—Ç—Å—è
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –õ–∏–º–∏—Ç = 2 (–ø–æ—Å–ª–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ marznode)
```
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 1 ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è ‚úÖ ‚Üí Marznode: —Ä–∞–∑—Ä–µ—à–µ–Ω–æ ‚úÖ
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 2 ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è ‚úÖ ‚Üí Marznode: —Ä–∞–∑—Ä–µ—à–µ–Ω–æ ‚úÖ
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 3 ‚Üí –ù–ï —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è ‚ùå ‚Üí Marznode: –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–û ‚ùå
```

## üéØ –î–ª—è –ø–æ–ª–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

### –ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ marznode –Ω—É–∂–Ω–æ:

1. **–†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å proto** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
2. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É** –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:

```go
if user.EnforceDeviceLimit && user.DeviceLimit != nil {
    fingerprint := calculateFingerprint(req)
    
    if !contains(user.AllowedFingerprints, fingerprint) {
        return errors.New("device not allowed")
    }
}
```

3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å calculateFingerprint** (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ Python):

```go
func calculateFingerprint(clientName, tlsFP, userAgent string) string {
    components := []string{"", clientName, tlsFP, "", userAgent}
    source := strings.Join(components, "|")
    hash := sha256.Sum256([]byte(source))
    return hex.EncodeToString(hash[:])
}
```

## üìÇ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- `app/marznode/marznode.proto` - —Ä–∞—Å—à–∏—Ä–µ–Ω –ø—Ä–æ—Ç–æ–∫–æ–ª
- `app/marznode/operations.py` - –ø–µ—Ä–µ–¥–∞—á–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- `app/marznode/grpcio.py` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞
- `app/marznode/grpclib.py` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞
- `app/marznode/database.py` - –ø–æ–ª—É—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- `app/routes/device.py` - –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- `app/utils/device_tracker.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ + —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- `app/config/env.py` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ ENFORCE_DEVICE_LIMITS_ON_PROXY

### –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö:
- `app/db/migrations/versions/20241219_add_device_limit.py` - –º–∏–≥—Ä–∞—Ü–∏—è
- `app/models/user.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ device_limit
- `app/db/models.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ device_limit

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç
```bash
curl -X PUT "http://localhost:8000/api/users/testuser" \
  -H "Authorization: Bearer TOKEN" \
  -d '{"device_limit": 2}'
```

### 2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å 2 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –û–±–∞ –¥–æ–ª–∂–Ω—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è ‚úÖ

### 3. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å 3-–µ
- –ù–µ –±—É–¥–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ Marzneshin ‚úÖ
- –ü—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ–∫–∞ marznode –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω) ‚ö†Ô∏è

### 4. –£–¥–∞–ª–∏—Ç—å –æ–¥–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
```bash
curl -X DELETE "http://localhost:8000/api/admin/users/testuser/devices/1" \
  -H "Authorization: Bearer TOKEN"
```

### 5. –¢–µ–ø–µ—Ä—å 3-–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
- –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ ‚úÖ

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `DEVICE_BLOCKING_IMPLEMENTATION.md` - –¥–µ—Ç–∞–ª—å–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `examples/test_device_limits.py` - –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API
- `DEVICE_LIMITS_RU.md` - –∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º

## ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç** –Ω–∞ —É—Ä–æ–≤–Ω–µ Marzneshin:
- ‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è
- ‚úÖ –õ–∏–º–∏—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è
- ‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∞ —É–∑–ª—ã

–î–ª—è **–∂–µ—Å—Ç–∫–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ –ø—Ä–æ–∫—Å–∏** —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ marznode.






