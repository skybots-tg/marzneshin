# üì± –ü—Ä–∏–Ω—Ü–∏–ø —É—á–µ—Ç–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ Marzneshin

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. **–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è—Ö**
–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ VPN –∫–ª–∏–µ–Ω—Ç:
- **Marznode** —Å–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞
- –§—É–Ω–∫—Ü–∏—è `fetch_users_stats()` –≤ `app/tasks/record_usages.py` –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å –Ω–æ–¥

### 2. **–î–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è**
```python
{
    "uid": user_id,              # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    "value": usage,              # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫
    "remote_ip": "1.2.3.4",     # IP –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞ (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)
    "client_name": "v2rayNG",   # –ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)
    "user_agent": "v2ray/1.0",  # User agent (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)
}
```

### 3. **–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–ø–µ—á–∞—Ç–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**
–í —Ñ—É–Ω–∫—Ü–∏–∏ `track_user_connection()` –∏–∑ `app/utils/device_tracker.py`:

```python
fingerprint = build_device_fingerprint(
    user_id=user_id,
    client_name=client_name,      # –ù–∞–ø—Ä–∏–º–µ—Ä: "v2rayNG"
    tls_fingerprint=None,          # TLS –æ—Ç–ø–µ—á–∞—Ç–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    user_agent=user_agent,         # User agent —Å—Ç—Ä–æ–∫–∞
)
```

–û—Ç–ø–µ—á–∞—Ç–æ–∫ = SHA256 —Ö—ç—à –æ—Ç: `user_id|client_name|tls_fingerprint|os_guess|user_agent`

### 4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î**
- **–¢–∞–±–ª–∏—Ü–∞ `user_devices`**: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
- **–¢–∞–±–ª–∏—Ü–∞ `user_device_ips`**: IP –∞–¥—Ä–µ—Å–∞ –∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è
- **–¢–∞–±–ª–∏—Ü–∞ `user_device_traffic`**: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞

## ‚ö†Ô∏è –ü–æ—á–µ–º—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –º–æ–≥—É—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è?

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Marznode –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
**–†–µ—à–µ–Ω–∏–µ:** –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å Marznode, —á—Ç–æ–±—ã –æ–Ω –ø–µ—Ä–µ–¥–∞–≤–∞–ª:
- `remote_ip` - IP –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞
- `client_name` - –ù–∞–∑–≤–∞–Ω–∏–µ VPN –∫–ª–∏–µ–Ω—Ç–∞
- `user_agent` - User agent —Å—Ç—Ä–æ–∫–∏

–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è Marznode –º–æ–∂–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ:
```python
for stat in await node.fetch_users_stats():
    if stat.usage:
        params.append({"uid": stat.uid, "value": stat.usage})
```

**–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å** –≤ protobuf –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (`app/marznode/marznode.proto`):
```protobuf
message UserStats {
    int32 uid = 1;
    int64 usage = 2;
    string remote_ip = 3;        // –ù–û–í–û–ï
    string client_name = 4;      // –ù–û–í–û–ï
    string user_agent = 5;       // –ù–û–í–û–ï
}
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ö–æ–¥ –ø–æ–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
–í `app/tasks/record_usages.py` —Å—Ç—Ä–æ–∫–∞ 136-146:
```python
# Track device connection if we have remote_ip
if param.get("remote_ip"):
    try:
        track_user_connection(...)
    except Exception as e:
        pass  # –ù–µ –ø–∞–¥–∞–µ–º, –µ—Å–ª–∏ —Ç—Ä–µ–∫–∏–Ω–≥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
```

**–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ù–ï –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –µ—Å–ª–∏:**
- `param.get("remote_ip")` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
- –í –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –Ω–µ—Ç –∫–ª—é—á–∞ `"remote_ip"`

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è `20241210_a1b2c3d4e5f6_add_device_tracking.py` –ø—Ä–∏–º–µ–Ω–µ–Ω–∞:

```bash
# –í –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞
cd /path/to/marzneshin

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic upgrade head

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã
sqlite3 marzneshin.db  # –∏–ª–∏ mysql/postgresql
.tables
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å: user_devices, user_device_ips, user_device_traffic
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—á–µ—Ç–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

### –í–∞—Ä–∏–∞–Ω—Ç 1: –í—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è —Ç–µ—Å—Ç–∞
```python
from app.db import GetDB
from app.utils.device_tracker import track_user_connection

with GetDB() as db:
    track_user_connection(
        db=db,
        user_id=1,  # ID –≤–∞—à–µ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        node_id=1,  # ID –Ω–æ–¥—ã
        remote_ip="192.168.1.100",
        client_name="v2rayNG",
        user_agent="v2ray/1.8.5",
        upload_bytes=0,
        download_bytes=1024*1024,  # 1 MB
    )
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
tail -f /var/log/marzneshin/marzneshin.log

# –ò—Å–∫–∞—Ç—å —Å—Ç—Ä–æ–∫–∏:
# "Created new device {device_id} for user {user_id}"
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î –Ω–∞–ø—Ä—è–º—É—é
```bash
# SQLite
sqlite3 marzneshin.db
SELECT * FROM user_devices;
SELECT * FROM user_device_ips;

# MySQL/MariaDB
mysql -u root -p marzneshin
SELECT * FROM user_devices;
SELECT * FROM user_device_ips;
```

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è –ø–æ–ª–Ω–æ–π —Ä–∞–±–æ—Ç—ã

### 1. –û–±–Ω–æ–≤–∏—Ç—å Marznode (backend)
–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–¥ –Ω–æ–¥—ã –ø–µ—Ä–µ–¥–∞—á—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:
- IP –∞–¥—Ä–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞
- –ù–∞–∑–≤–∞–Ω–∏–µ VPN –∫–ª–∏–µ–Ω—Ç–∞
- User agent (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å protobuf –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
–§–∞–π–ª: `app/marznode/marznode.proto`
–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ `UserStats` message

### 3. –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å protobuf –∫–æ–¥
```bash
python -m grpc_tools.protoc \
    -I. \
    --python_out=. \
    --grpc_python_out=. \
    app/marznode/marznode.proto
```

### 4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–±–æ—Ä –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Xray/Sing-box
–í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–æ–∫—Å–∏ –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- IP –∞–¥—Ä–µ—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤
- –¢–∏–ø–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ø–æ TLS fingerprint)

## üìä –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç–∞—é—â–µ–π —Å–∏—Å—Ç–µ–º—ã

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ v2rayNG —Å Android
2. Marznode –≤–∏–¥–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ —Å–æ–±–∏—Ä–∞–µ—Ç:
   - `uid=7`, `value=1024000`, `remote_ip="1.2.3.4"`, `client_name="v2rayNG"`
3. `record_user_usages()` –≤—ã–∑—ã–≤–∞–µ—Ç `track_user_connection()`
4. –°–æ–∑–¥–∞–µ—Ç—Å—è:
   - –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: `fingerprint=sha256("7|v2rayNG|...")`
   - IP –∑–∞–ø–∏—Å—å: `ip="1.2.3.4"`, `country="RU"`
   - –¢—Ä–∞—Ñ–∏–∫: `download_bytes=1024000`
5. –í UI –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç:
   - üì± Android - v2rayNG
   - üåç IP: 1.2.3.4 (Russia)
   - üìä –¢—Ä–∞—Ñ–∏–∫: 1 MB

## üéØ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)

–ü–æ–∫–∞ Marznode –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IP –∞–¥—Ä–µ—Å –∏–∑ `online_at`:

```python
# –í app/tasks/record_usages.py –¥–æ–±–∞–≤–∏—Ç—å fallback:
# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π IP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥—Ä—É–≥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
user = db.query(User).filter(User.id == uid).first()
if user and not param.get("remote_ip"):
    # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–ª—É—á–∏—Ç—å IP –∏–∑ –¥—Ä—É–≥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    param["remote_ip"] = get_user_last_ip(user)  # –ù—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞, –∫–æ–¥ –≥–æ—Ç–æ–≤  
**–¢—Ä–µ–±—É–µ—Ç—Å—è:** üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Marznode –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

